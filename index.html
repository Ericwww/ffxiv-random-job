<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIV éšæœºèŒä¸šåŠ©æ‰‹</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root { --bg: #23272a; --card-bg: #2c2f33; --accent: #7289da; --t-color: #3498db; --h-color: #2ecc71; --d-color: #e74c3c; }
        body { font-family: "Helvetica Neue", Helvetica, "PingFang SC", sans-serif; background: var(--bg); color: #dcddde; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.5; }
        [v-cloak] { display: none; }
        .card { background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid #444; }
        
        .job-icon { width: 28px; height: 28px; vertical-align: middle; border-radius: 4px; background: #111; }
        .job-icon.large { width: 40px; height: 40px; }
        .role-icon { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 15px; }
        .result-card { background: #36393f; padding: 12px; border-radius: 6px; display: flex; align-items: center; border-left: 5px solid #fff; }
        .res-t { border-color: var(--t-color); } .res-h { border-color: var(--h-color); } .res-d { border-color: var(--d-color); }
        .res-info { margin-left: 12px; }
        .res-name { font-size: 0.85em; color: #b9bbbe; margin-bottom: 2px; }
        .res-job { font-weight: bold; font-size: 1.1em; color: #fff; display: flex; align-items: center; gap: 5px; }

        .job-tag { display: inline-flex; align-items: center; padding: 5px 8px; margin: 3px; background: #4f545c; border-radius: 4px; cursor: pointer; font-size: 13px; gap: 6px; border: 1px solid transparent; transition: 0.15s; }
        .job-tag.active.t-bg { background: var(--t-color); border-color: #fff; }
        .job-tag.active.h-bg { background: var(--h-color); border-color: #fff; }
        .job-tag.active.d-bg { background: var(--d-color); border-color: #fff; }

        .role-btn { cursor: pointer; font-weight: bold; margin-right: 15px; color: #eee; min-width: 85px; display: flex; align-items: center; padding: 5px; border-radius: 4px; }
        .role-btn:hover { background: rgba(255,255,255,0.1); }
        
        input { background: #202225; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; outline: none; width: 150px; }
        .btn-main { background: #43b581; color: white; border: none; padding: 15px; border-radius: 6px; flex: 2; font-size: 1.1em; cursor: pointer; font-weight: bold; }
        .btn-main:hover { background: #3ca374; }
        .btn-clear { background: #747f8d; color: white; border: none; padding: 15px; border-radius: 6px; flex: 1; cursor: pointer; margin-left: 10px; }
        
        .flex-row { display: flex; align-items: center; gap: 10px; }
        select { background: #2f3136; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; flex: 1; }
        .desc { font-size: 0.85em; color: #8e9297; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>FFXIV éšæœºèŒä¸šåŠ©æ‰‹</h2>
    </div>

    <div class="card">
        <div class="flex-row">
            <label>é¢„è®¾é˜µå®¹ï¼š</label>
            <select v-model="selectedComp">
                <option v-for="c in compositions" :value="c.value">{{ c.label }}</option>
            </select>
        </div>
        <p class="desc">ğŸ’¡ æç¤ºï¼šé€‰æ‹©â€œè‡ªç”±äººæ•°â€å¯è§£é™¤äººæ•°æ ¡éªŒï¼Œé€‚åˆäººä¸æ»¡ä¹Ÿæƒ³æŠ½èŒä¸šçš„åœºæ™¯ã€‚</p>
        <div style="display: flex; margin-top: 15px;">
            <button class="btn-main" @click="generate">ğŸ² å¼€å§‹æŠ½å–èŒä¸š</button>
            <button v-if="results.length" class="btn-clear" @click="results = []">æ¸…ç©ºç»“æœ</button>
        </div>
    </div>

    <div v-if="results.length" class="card" style="border: 2px solid #43b581;">
        <h3 style="margin-top:0; color: #43b581;">âœ¨ æŠ½å–ç»“æœ</h3>
        <div class="result-grid">
            <div v-for="(res, idx) in results" :key="idx" :class="['result-card', 'res-'+res.role.toLowerCase()]">
                <img :src="'./static/icons/' + JOB_MAP[res.job] + '.png'" class="job-icon large">
                <div class="res-info">
                    <div class="res-name">{{ res.playerName }}</div>
                    <div class="res-job">
                        <img :src="'./static/icons/role_' + res.role.toLowerCase() + '.png'" class="role-icon">
                        {{ res.job }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <h3>æˆå‘˜åå• ({{ players.length }})</h3>
        <div class="flex-row">
            <button @click="resetSelections" style="background:none; border:1px solid #747f8d; color:#747f8d; padding:5px 10px; border-radius:4px; cursor:pointer; font-size: 12px;">é‡ç½®å‹¾é€‰</button>
            <button @click="addPlayer" style="background:var(--accent); color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight: bold;">+ æ·»åŠ è§’è‰²</button>
        </div>
    </div>

    <div v-for="(player, pIdx) in players" :key="pIdx" class="card">
        <div style="display:flex; justify-content: space-between; margin-bottom: 15px;">
            <div class="flex-row">
                <input type="text" v-model="player.name" @change="save" placeholder="è§’è‰²æ˜µç§°">
            </div>
            <button @click="removePlayer(pIdx)" style="color:#ff4757; background:none; border:none; cursor:pointer;">åˆ é™¤</button>
        </div>

        <div v-for="(jobs, role) in allJobs" :key="role" style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <div class="role-btn" @click="toggleRole(pIdx, role)">
                <img :src="'./static/icons/role_' + role.toLowerCase() + '.png'" class="role-icon">
                {{ roleName(role) }}
            </div>
            <div style="flex: 1;">
                <span v-for="job in jobs" 
                      :class="['job-tag', player.selectedJobs.includes(job) ? 'active ' + role.toLowerCase() + '-bg' : '']"
                      @click="toggleJob(pIdx, job)">
                    <img :src="'./static/icons/' + JOB_MAP[job] + '.png'" class="job-icon">
                    {{ job }}
                </span>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

const JOB_MAP = {
    'éª‘å£«':'Paladin', 'æˆ˜å£«':'Warrior', 'æš—é»‘éª‘å£«':'Dark_Knight', 'ç»æªæˆ˜å£«':'Gunbreaker',
    'ç™½é­”æ³•å¸ˆ':'White_Mage', 'å­¦è€…':'Scholar', 'å æ˜Ÿæœ¯å£«':'Astrologian', 'è´¤è€…':'Sage',
    'é¾™éª‘å£«':'Dragoon', 'æ­¦å£«':'Samurai', 'å¿è€…':'Ninja', 'é’é•°å®¢':'Reaper', 'è°è›‡å‰‘å£«':'Viper', 'æ­¦åƒ§':'Monk', 
    'é»‘é­”æ³•å¸ˆ':'Black_Mage', 'å¬å”¤å¸ˆ':'Summoner', 'èµ¤é­”æ³•å¸ˆ':'Red_Mage', 'ç»˜çµæ³•å¸ˆ':'Pictomancer',
    'è¯—äºº':'Bard', 'æœºå·¥å£«':'Machinist', 'èˆè€…':'Dancer', 
};

createApp({
    data() {
        return {
            JOB_MAP,
            allJobs: {
                T: ['éª‘å£«', 'æˆ˜å£«', 'æš—é»‘éª‘å£«', 'ç»æªæˆ˜å£«'],
                H: ['ç™½é­”æ³•å¸ˆ', 'å­¦è€…', 'å æ˜Ÿæœ¯å£«', 'è´¤è€…'],
                D: ['é¾™éª‘å£«', 'æ­¦å£«', 'å¿è€…', 'é’é•°å®¢', 'è°è›‡å‰‘å£«', 'æ­¦åƒ§', 'é»‘é­”æ³•å¸ˆ', 'å¬å”¤å¸ˆ', 'èµ¤é­”æ³•å¸ˆ', 'ç»˜çµæ³•å¸ˆ', 'è¯—äºº', 'æœºå·¥å£«', 'èˆè€…']
            },
            compositions: [
                { label: '4äººè½»é” (1T 1H 2D)', value: 'THDD' },
                { label: '8äººæ»¡ç¼– (2T 2H 4D)', value: 'TTHHDDDD' },
                { label: '4äººç»ƒT (1T 3D)', value: 'TDDD' },
                { label: 'å›¢é˜Ÿéšæœº (1T 2H 5D)', value: 'THHDDDDD' },
                { label: 'è‡ªç”±äººæ•° (FREE)', value: 'FREE' }
            ],
            selectedComp: 'THDD',
            players: [],
            results: []
        }
    },
    watch: {
        // æ ¸å¿ƒæ”¹åŠ¨ï¼šç›‘å¬é˜µå®¹åˆ‡æ¢ï¼Œè‡ªåŠ¨è¡¥äºº
        selectedComp(newVal) {
            let targetCount = newVal === 'FREE' ? 4 : newVal.length;
            this.adjustPlayerCount(targetCount);
        }
    },
    mounted() {
        const saved = localStorage.getItem('ff14_roller_v1');
        if (saved) {
            this.players = JSON.parse(saved);
        }
        // åˆå§‹åŒ–è¡¥äººé€»è¾‘
        let initialTarget = this.selectedComp === 'FREE' ? 4 : this.selectedComp.length;
        this.adjustPlayerCount(initialTarget);
    },
    methods: {
        roleName(r) { return {T:'å¦å…‹', H:'æ²»ç–—', D:'è¾“å‡º'}[r]; },
        // è‡ªåŠ¨è¡¥é½äººæ•°çš„æ–¹æ³•
        adjustPlayerCount(target) {
            while (this.players.length < target) {
                this.addPlayer(false); // false è¡¨ç¤ºè¡¥äººæ—¶ä¸ç«‹å³è§¦å‘ saveï¼Œå‡å°‘ IO
            }
            while (this.players.length > target) {
                this.players.pop();
            }
            this.save();
        },
        addPlayer(shouldSave = true) {
            this.players.push({
                name: 'å†’é™©è€…' + (this.players.length + 1),
                selectedJobs: [...this.allJobs.T, ...this.allJobs.H, ...this.allJobs.D]
            });
            if (shouldSave) this.save();
        },
        removePlayer(idx) {
            this.players.splice(idx, 1);
            this.save();
        },
        resetSelections() {
            this.players.forEach(p => p.selectedJobs = [...this.allJobs.T, ...this.allJobs.H, ...this.allJobs.D]);
            this.save();
        },
        toggleJob(pIdx, job) {
            const list = this.players[pIdx].selectedJobs;
            const index = list.indexOf(job);
            if (index > -1) list.splice(index, 1);
            else list.push(job);
            this.save();
        },
        toggleRole(pIdx, role) {
            const roleJobs = this.allJobs[role];
            const pJobs = this.players[pIdx].selectedJobs;
            const hasAll = roleJobs.every(j => pJobs.includes(j));
            if (hasAll) this.players[pIdx].selectedJobs = pJobs.filter(j => !roleJobs.includes(j));
            else roleJobs.forEach(j => { if (!pJobs.includes(j)) pJobs.push(j); });
            this.save();
        },
        save() { localStorage.setItem('ff14_roller_v1', JSON.stringify(this.players)); },
        generate() {
            let rolesNeeded = [];
            if (this.selectedComp === 'FREE') {
                const count = this.players.length;
                if (count === 0) return;
                if (count >= 1) rolesNeeded.push('T');
                if (count >= 2) rolesNeeded.push('H');
                for (let i = 0; i < count - 2; i++) rolesNeeded.push('D');
            } else {
                rolesNeeded = this.selectedComp.split('');
                if (rolesNeeded.length !== this.players.length) {
                    alert(`âŒ äººæ•°ä¸ç¬¦ï¼å½“å‰æ¨¡å¼éœ€è¦ ${rolesNeeded.length} äººï¼Œä½†ä½ åå•é‡Œæœ‰ ${this.players.length} äººã€‚\n\nå·²è‡ªåŠ¨ä¸ºä½ è¡¥é½/è°ƒæ•´äººæ•°ã€‚`);
                    this.adjustPlayerCount(rolesNeeded.length);
                    return;
                }
            }

            const shuffledPlayers = [...this.players].sort(() => Math.random() - 0.5);
            let finalMap = [];
            const backtrack = (idx, currentAlloc) => {
                if (idx === rolesNeeded.length) { finalMap = currentAlloc; return true; }
                const roleNeeded = rolesNeeded[idx];
                const player = shuffledPlayers[idx];
                let possibleJobs = player.selectedJobs.filter(j => this.allJobs[roleNeeded].includes(j));
                possibleJobs.sort(() => Math.random() - 0.5);
                for (let job of possibleJobs) {
                    if (backtrack(idx + 1, [...currentAlloc, { playerName: player.name, job, role: roleNeeded }])) return true;
                }
                return false;
            };

            if (backtrack(0, [])) {
                this.results = finalMap;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                alert("ğŸ˜­ æ— æ³•åˆ†é…èŒä¸šï¼è¯·ç¡®ä¿å‹¾é€‰äº†å¯¹åº”èŒè´£ã€‚");
            }
        }
    }
}).mount('#app');
</script>
</body>
</html>